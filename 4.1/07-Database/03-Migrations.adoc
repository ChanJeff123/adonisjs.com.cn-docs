---
permalink: migrations
title: 迁移
category: 数据库
---

= 迁移

toc::[]

迁移是记录数据库变化的过程（利用代码操作数据库，而不是原生 SQL），在整个应用程序的开发生命周期中创建，你可以随时回滚或重新运行。

迁移使团队工作变得更加容易，可以轻松的跟踪一个开发人员对数据库架构的更改，然后被组织中的其他开发人员应用。

== 创建迁移

NOTE: 要使用迁移，必须首先在 `start/app.js` 文件的 `aceProviders` 数组中注册 link:database#_setup[Migrations Provider 迁移提供者]。

让我们在迁移的帮助下创建一个 *用户* 表。

首先，调用 `adonis make:migration` 命令创建一个 schema 文件：

[source, bash]
----
> adonis make:migration users
----

出现提示时，选择 `Create table` 选型然后按 kbd:[Enter] 回车键：

.Output
[source, bash]
----
✔ create  database/migrations/1502691651527_users_schema.js
----

你的 schema 文件将会在 `database/migrations` 目录中创建（以当前时间戳为前缀），可以根据需要进行修改：

.database/migrations/...users_schema.js
[source, js]
----
'use strict'

const Schema = use('Schema')

class UsersSchema extends Schema {
  up () {
    this.create('users', (table) => {
      table.increments()
      table.timestamps()
    })
  }

  down () {
    this.drop('users')
  }
}

module.exports = UsersSchema
----

== Schema 文件

一个 schema 文件需要包含两个方法： `up` 和 `down`。

=== up()

`up` 方法用于对表执行操作，它用于创建新表或更改现有表。

=== down()

`down` 方法用于还原 `up` 方法中应用的更改。当使用 `up` 创建表时，便可用 `down` 来删除该表。

使用以下代码更新 link:#_creating_migrations[你刚刚创建的] schema 文件：

.database/migrations/...users_schema.js
[source, js]
----
'use strict'

const Schema = use('Schema')

class UsersSchema extends Schema {
  up () {
    this.create('users', (table) => {
      table.increments()
      table.string('username', 80).notNullable().unique()
      table.string('email', 254).notNullable().unique()
      table.string('password', 60).notNullable()
      table.timestamps()
    })
  }

  down () {
    this.drop('users')
  }
}

module.exports = UsersSchema
----

上面的示例中演示了如何使用 schema 文件创建/更改数据库表，将不同的 link:#_column_typesmodifiers[列类型/修饰符方法] 链接在一起，以定义 `up` 方法中各个字段属性的特征。

== 列类型/修饰符

NOTE: 有关 schema 的列类型和修饰符方法的完整列表，请参阅 link:https://knexjs.org/#Schema-Building[Knex API, window="_blank"] 文档。

=== 列类型
[options="header", cols="50, 50"]
|====
| 方法 | 描述
| `table.bigInteger(name)` | 添加一个 link:https://knexjs.org/#Schema-bigInteger[bigint, window="blank"]（大整数） 列。
| `table.binary(name, [length])` | 添加一个 link:https://knexjs.org/#Schema-binary[binary, window="blank"]（二进制）列。
| `table.boolean(name)` | 添加一个 link:https://knexjs.org/#Schema-boolean[boolean, window="blank"]（布尔）列。
| `table.date(name)` | 添加一个 link:https://knexjs.org/#Schema-date[date, window="blank"]（日期）列。
| `table.datetime(name, [precision])` | 添加一个 link:https://knexjs.org/#Schema-datetime[datetime, window="blank"]（日期时间）列。
| `table.decimal(name, [precision], [scale])` | 添加一个 link:https://knexjs.org/#Schema-decimal[decimal, window="blank"]（十进制）列。
| `table.enu(col, values, [options])` | 添加一个 link:https://knexjs.org/#Schema-enum[enum, window="blank"]（枚举）列。
| `table.float(name, [precision], [scale])` | 添加一个 link:https://knexjs.org/#Schema-float[float, window="blank"]（浮点）列。
| `table.increments(name)` | 添加一个 link:https://knexjs.org/#Schema-increments[auto incrementing, window="_blank"]（自动递增）列。
| `table.integer(name)` | 添加一个 link:https://knexjs.org/#Schema-integer[integer, window="blank"]（整数）列。
| `table.json(name)` | 添加一个 link:https://knexjs.org/#Schema-json[json, window="blank"] 列。
| `table.string(name, [length=255])` | 添加一个 link:https://knexjs.org/#Schema-string[string, window="blank"]（字符串）列。
| `table.text(name, [textType])` | 添加一个 link:https://knexjs.org/#Schema-text[text, window="blank"]（文本）列。
| `table.time(name, [precision])` | 添加一个 link:https://knexjs.org/#Schema-time[time, window="blank"] （时间）列。
| `table.timestamp(name, [useTz], [precision])` | 添加一个 link:https://knexjs.org/#Schema-timestamp[timestamp, window="blank"]（时间戳）列。
| `table.timestamps([useTimestamps], [defaultToNow])` | 添加 link:https://knexjs.org/#Schema-timestamps[创建/更新, window="blank"] 列.
| `table.uuid(name)` | 添加一个 link:https://knexjs.org/#Schema-uuid[uuid, window="blank"]（通用唯一标示符）列。
|====

=== 列修饰符
[options="header", cols="40, 60"]
|====
| 方法 | Description
| `.after(field)` | Set column to be inserted link:https://knexjs.org/#Schema-after[after, window="blank"] `field`.
| `.alter()` | Marks the column as an link:https://knexjs.org/#Schema-alter[alter/modify, window="blank"].
| `.collate(collation)` | Set column link:https://knexjs.org/#Chainable[collation, window="blank"] (e.g. `utf8_unicode_ci`).
| `.comment(value)` | Set column link:https://knexjs.org/#Schema-comment[comment, window="blank"].
| `.defaultTo(value)` | Set column link:https://knexjs.org/#Schema-defaultTo[default value, window="blank"].
| `.first()` | Set column to be inserted at the link:https://knexjs.org/#Schema-first[first position, window="blank"].
| `.index([indexName], [indexType])` | Specifies column as an link:https://knexjs.org/#Chainable[index, window="blank"].
| `.inTable(table)` | Set link:https://knexjs.org/#Schema-inTable[foreign key table, window="blank"] (chain after `.references`).
| `.notNullable()` | Set column to link:https://knexjs.org/#Schema-notNullable[not null, window="blank"].
| `.nullable()` | Set column to be link:https://knexjs.org/#Schema-nullable[nullable, window="blank"].
| `.primary([constraintName])` | Set column as the link:https://knexjs.org/#Schema-primary[primary key, window="blank"] for a table.
| `.references(column)` | Set link:https://knexjs.org/#Schema-references[foreign key column, window="blank"].
| `.unique()` | Set column as link:https://knexjs.org/#Chainable[unique, window="blank"].
| `.unsigned()` | Set column to link:https://knexjs.org/#Schema-unsigned[unsigned, window="blank"] (if integer).
|====

== 多个连接
Schema files can use a different connection by defining a `connection` getter (ensure your different connection exists inside the `config/database.js` file):

.database/migrations/...users_schema.js
[source, js]
----
const Schema = use('Schema')

class UsersSchema extends Schema {
  static get connection () {
    return 'mysql'
  }

  // ...
}

module.exports = UsersSchema
----

NOTE: The database table `adonis_schema` is always created inside the default connection database to manage the lifecycle of migrations (there is no option to override it).

== 运行迁移
We need to call the `migration:run` command to run migrations (which executes the `up` method on all pending migration files):

[source, bash]
----
> adonis migration:run
----

.Output
[source, bash]
----
migrate: 1502691651527_users_schema.js
Database migrated successfully in 117 ms
----

== 迁移状态
You can check the status of all migrations by running the following command:

[source, bash]
----
> adonis migration:status
----

link:http://res.cloudinary.com/adonisjs/image/upload/q_100/v1502694030/migration-status_zajqib.jpg[image:http://res.cloudinary.com/adonisjs/image/upload/q_100/v1502694030/migration-status_zajqib.jpg[], window="_blank"]

TIP: The *batch* value exists as a reference you can use to limit rollbacks at a later time.

That is how migrations work under the hood:

1. Calling `adonis migration:run` runs all pending schema files and assigns them to a new batch.
2. Once a batch of migration files are run, they are not run again.
3. Calling `adonis migration:rollback` rollbacks the last batch of migrations in reverse order.

TIP: Don't create multiple tables in a single schema file. Instead, create a new file for each database change. This way you keep your database atomic and can roll back to any version.

== 迁移命令
Below is the list of available migration commands.

=== 命令列表
[options="header"]
|====
| Command  | Description
| `make:migration` | Create a new migration file.
| `migration:run` | Run all pending migrations.
| `migration:rollback` | Rollback last set of migrations.
| `migration:refresh` | Rollback all migrations to the `0` batch then re-run them from the start.
| `migration:reset` | Rollback all migrations to the `0` batch.
| `migration:status` | Get the status of all the migrations.
|====


=== 命令帮助
For detailed command options, append `--help` to a each migration command:


[source, bash]
----
> adonis migration:run --help
----

.Output
[source, bash]
----
Usage:
  migration:run [options]

Options:
  -f, --force   Forcefully run migrations in production
  -s, --silent  Silent the migrations output
  --seed        Seed the database after migration finished
  --log         Log SQL queries instead of executing them

About:
  Run all pending migrations
----

== Schema 表 API
Below is the list of schema methods available to interact with database tables.

==== create
Create a new database table:

[source, js]
----
up () {
  this.create('users', (table) => {
  })
}
----

==== createIfNotExists
Create a new database table (only if it doesn't exist):

[source, js]
----
up () {
  this.createIfNotExists('users', (table) => {
  })
}
----

==== rename(from, to)
Rename an existing database table:

[source, js]
----
up () {
  this.rename('users', 'my_users')
}
----

==== drop
Drop a database table:

[source, js]
----
down () {
  this.drop('users')
}
----

==== dropIfExists
Drop a database table (only if it exists):

[source, js]
----
down () {
  this.dropIfExists('users')
}
----

==== alter
Select a database table for alteration:

[source, js]
----
up () {
  this.alter('users', (table) => {
    // add new columns or remove existing
  })
}
----

==== raw
Run an arbitrary SQL query:

[source, js]
----
up () {
  this
    .raw("SET sql_mode='TRADITIONAL'")
    .table('users', (table) => {
      table.dropColumn('name')
      table.string('first_name')
      table.string('last_name')
    })
}
----

==== hasTable
Returns whether a table exists or not (this is an `async` method):

[source, js]
----
async up () {
  const exists = await this.hasTable('users')

  if (!exists)  {
    this.create('up', (table) => {
    })
  }
}
----

== 扩展
Below is the list of extension methods you can execute when running migrations.

NOTE: Extensions only work with a PostgreSQL database.

==== createExtension(extensionName)
Create a database extension:

[source, javascript]
----
class UserSchema {
  up () {
    this.createExtension('postgis')
  }
}
----

==== createExtensionIfNotExists(extensionName)
Create a database extension (only if doesn't exist):

[source, javascript]
----
class UserSchema {
  up () {
    this.createExtensionIfNotExists('postgis')
  }
}
----

==== dropExtension(extensioName)
Drop a database extension:

[source, javascript]
----
class UserSchema {
  down () {
    this.dropExtension('postgis')
  }
}
----

==== dropExtensionIfExists(extensionName)
Drop a database extension (only if it exists):

[source, javascript]
----
class UserSchema {
  down () {
    this.dropExtensionIfExists('postgis')
  }
}
----

== 执行任意代码
Commands written inside the `up` and `down` methods are scheduled to be executed later inside a migration.

If you need to execute *arbitrary* database commands, wrap them inside the `schedule` function:


[source, javascript]
----
class UserSchema {
  up () {
    // create new table
    this.create('new_users', (table) => {
    })

    // copy data
    this.schedule(async (trx) => {
      const users = await Database.table('users').transacting(trx)
      await Database.table('new_users').transacting(trx).insert(users)
    })

    // drop old table
    this.drop('users')
  }
}
----

NOTE: The `schedule` method receives a *transaction object*. It is important to run all database commands inside the same transaction, otherwise your queries will hang forever.

== Schema 构造器 API
The schema builder API uses the link:http://knexjs.org/#Schema-Building[Knex API, window="_blank"], so make sure to read their documentation for more information.

==== fn.now()
Knex has a method called link:http://knexjs.org/#Schema-timestamp[knex.fn.now(), window="_blank"], which is used to set the current timestamp on the database field.

In AdonisJs, you reference this method as `this.fn.now()`:

[source, js]
----
up () {
  this.table('users', (table) => {
    table.timestamp('created_at').defaultTo(this.fn.now())
  })
}
----
